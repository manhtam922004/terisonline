<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Tetris</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .game-container {
            display: none;
        }
        canvas {
            border: 1px solid #000;
            background: #fff;
        }
        .opponent-board {
            background: #f0f0f0;
        }
    </style>
</head>
<body class="bg-dark text-light">
    <div class="container text-center mt-5">
        <h1 class="mb-4">Multiplayer Tetris</h1>
        
        <!-- Main Menu -->
        <div id="mainMenu">
            <button class="btn btn-primary btn-lg" onclick="startMatchmaking()">Play Now</button>
            <div id="waitingMessage" class="mt-3" style="display: none;">
                Waiting for opponent...
            </div>
        </div>

        <!-- Game Container -->
        <div class="game-container row justify-content-center">
            <div class="col-md-5">
                <h3>Your Board</h3>
                <canvas id="board" width="240" height="400"></canvas>
                <div class="mt-3">
                    Score: <span id="score">0</span>
                </div>
            </div>
            <div class="col-md-5">
                <h3>Opponent's Board</h3>
                <canvas id="opponentBoard" class="opponent-board" width="240" height="400"></canvas>
                <div class="mt-3">
                    Score: <span id="opponentScore">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4sGv7jJz8K5r7Q7Z8X7q7Z8X7q7Z8X7",
            authDomain: "waitcall-87f5e.firebaseapp.com",
            databaseURL: "https://waitcall-87f5e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "waitcall-87f5e",
            storageBucket: "waitcall-87f5e.firebasestorage.app",
            messagingSenderId: "535766267900",
            appId: "1:535766267900:web:572b04459493c157bd6479"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Game variables
        let gameRoomRef;
        let userId;
        let isHost = false;
        let tetris;
        let opponentTetris;

        class Tetris {
            constructor(canvas, onUpdate) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.board = Array(20).fill().map(() => Array(10).fill(0));
                this.score = 0;
                this.onUpdate = onUpdate;
                
                // Tetris pieces and logic
                // ... (Thêm logic xử lý Tetris ở đây)
            }

            // Các phương thức Tetris (update, draw, move, rotate, etc.)
            // ...
        }

        async function startMatchmaking() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('waitingMessage').style.display = 'block';
            
            userId = Math.random().toString(36).substr(2, 9);
            
            const waitingPlayers = await db.collection('waitingPlayers').get();
            if (waitingPlayers.empty) {
                // No players waiting, become host
                isHost = true;
                await db.collection('waitingPlayers').doc(userId).set({
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Wait for player
                db.collection('waitingPlayers').onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added' && !isHost) {
                            startGame(change.doc.id);
                        }
                    });
                });
            } else {
                // Join existing game
                const host = waitingPlayers.docs[0];
                await db.collection('waitingPlayers').doc(host.id).delete();
                startGame(host.id);
            }
        }

        function startGame(roomId) {
            gameRoomRef = db.collection('games').doc(roomId);
            document.querySelector('.game-container').style.display = 'flex';
            document.getElementById('waitingMessage').style.display = 'none';

            // Initialize game
            tetris = new Tetris(document.getElementById('board'), updateGameState);
            opponentTetris = new Tetris(document.getElementById('opponentBoard'), () => {});

            if (isHost) {
                gameRoomRef.set({
                    player1: userId,
                    player2: '',
                    gameState: {
                        player1: tetris,
                        player2: opponentTetris
                    }
                });
            } else {
                gameRoomRef.update({
                    player2: userId
                });
            }

            // Listen for game updates
            gameRoomRef.onSnapshot((doc) => {
                const data = doc.data();
                if (data.gameState) {
                    // Update opponent state
                    if (userId === data.player1) {
                        opponentTetris = data.gameState.player2;
                    } else {
                        opponentTetris = data.gameState.player1;
                    }
                    updateOpponentDisplay();
                }
            });

            // Start game loop
            setInterval(gameLoop, 1000);
        }

        function updateGameState() {
            gameRoomRef.update({
                gameState: {
                    player1: isHost ? tetris : opponentTetris,
                    player2: isHost ? opponentTetris : tetris
                }
            });
        }

        function updateOpponentDisplay() {
            document.getElementById('opponentScore').textContent = opponentTetris.score;
            // Vẽ lại opponent board
            opponentTetris.draw();
        }

        function gameLoop() {
            tetris.update();
            tetris.draw();
            document.getElementById('score').textContent = tetris.score;
        }

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            switch(e.keyCode) {
                case 37: // Left
                    tetris.move(-1);
                    break;
                case 39: // Right
                    tetris.move(1);
                    break;
                case 40: // Down
                    tetris.drop();
                    break;
                case 38: // Up (Rotate)
                    tetris.rotate();
                    break;
            }
        });
    </script>
</body>
</html>
